<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOC Dashboard</title>
<style>
:root{
--bg:#0b1020; --card:#111827; --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --blue:#2563eb;
--low:#22c55e; --med:#f59e0b; --high:#f97316; --crit:#ef4444;
}
body { font-family: Arial, sans-serif; margin: 20px; background:var(--bg); color:var(--text); }
h1 { margin:0 0 6px 0; }
.muted { color:var(--muted); margin-bottom:14px; }
.topbar,.filters { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.row { display:flex; gap:20px; flex-wrap:wrap; }
.card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:16px; flex:1; min-width:320px; }
table { width:100%; border-collapse: collapse; font-size: 14px; }
th, td { border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align:top; }
th { color:#93c5fd; }
button { background:var(--blue); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
button.secondary { background:#374151; }
input,select {
padding:8px; border-radius:8px; border:1px solid #374151; background:#0f172a; color:white;
}
input { width:220px; }
.ok { color:#34d399; } .warn { color:#fbbf24; }
.pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:bold; text-transform:uppercase; }
.sev-low { background:rgba(34,197,94,.15); color:var(--low); border:1px solid rgba(34,197,94,.35);}
.sev-medium { background:rgba(245,158,11,.15); color:var(--med); border:1px solid rgba(245,158,11,.35);}
.sev-high { background:rgba(249,115,22,.15); color:var(--high); border:1px solid rgba(249,115,22,.35);}
.sev-critical { background:rgba(239,68,68,.15); color:var(--crit); border:1px solid rgba(239,68,68,.35);}
.sev-unknown { background:rgba(156,163,175,.15); color:#d1d5db; border:1px solid rgba(156,163,175,.35);}
.count { font-size: 13px; color:var(--muted); margin-left:6px; }
</style>
</head>
<body>
<h1>üõ°Ô∏è SOC Dashboard</h1>
<div class="muted">Agents + recent telemetry</div>

<div class="topbar">
<label>API Key:</label>
<input id="apiKey" value="soc-dev-key" />
<button onclick="loadAll()">Refresh</button>
<button class="secondary" onclick="exportCsv()">Export Telemetry CSV</button>
<span id="status" class="muted"></span>
</div>

<div class="filters">
<input id="searchBox" placeholder="Search message/type/source..." oninput="renderTelemetry()" />
<select id="agentFilter" onchange="renderTelemetry()">
<option value="">All agents</option>
</select>
<select id="severityFilter" onchange="renderTelemetry()">
<option value="">All severity</option>
<option value="low">low</option>
<option value="medium">medium</option>
<option value="high">high</option>
<option value="critical">critical</option>
</select>
<select id="typeFilter" onchange="renderTelemetry()">
<option value="">All types</option>
</select>
</div>

<div class="row">
<div class="card">
<h3>Agents <span id="agentCount" class="count"></span></h3>
<table id="agentsTable">
<thead>
<tr><th>AgentId</th><th>Host</th><th>User</th><th>Version</th><th>Registered</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="card">
<h3>Recent Telemetry <span id="telemetryCount" class="count"></span></h3>
<table id="telemetryTable">
<thead>
<tr><th>Time</th><th>Agent</th><th>Type</th><th>Severity</th><th>Message</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="card" style="margin-top:20px;">
<h3>üö® Alerts (High/Critical) <span id="alertCount" class="count"></span></h3>
<table id="alertsTable">
<thead>
<tr><th>Time</th><th>Agent</th><th>Type</th><th>Severity</th><th>Message</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
<script>
let agentsData = [];
let telemetryData = [];

async function apiGet(path) {
const key = document.getElementById('apiKey').value.trim();
const res = await fetch(path, { headers: { 'X-API-Key': key } });
if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
return res.json();
}

function toArray(x){ return Array.isArray(x) ? x : (x ? [x] : []); }

function normalizeSeverity(s){
const v = (s || '').toLowerCase();
if (['low','medium','high','critical'].includes(v)) return v;
return 'unknown';
}

function sevBadge(s){
const v = normalizeSeverity(s);
return `<span class="pill sev-${v}">${v}</span>`;
}

function populateFilters() {
const agentFilter = document.getElementById('agentFilter');
const typeFilter = document.getElementById('typeFilter');

const agents = [...new Set(telemetryData.map(t => t.agentId).filter(Boolean))].sort();
const types = [...new Set(telemetryData.map(t => t.eventType).filter(Boolean))].sort();

const currentAgent = agentFilter.value;
const currentType = typeFilter.value;

agentFilter.innerHTML = '<option value="">All agents</option>' + agents.map(a => `<option value="${a}">${a}</option>`).join('');
typeFilter.innerHTML = '<option value="">All types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');

agentFilter.value = agents.includes(currentAgent) ? currentAgent : "";
typeFilter.value = types.includes(currentType) ? currentType : "";
}

function renderAgents() {
const tbody = document.querySelector('#agentsTable tbody');
tbody.innerHTML = '';
for (const a of agentsData) {
tbody.innerHTML += `<tr>
<td>${a.agentId ?? ''}</td>
<td>${a.hostname ?? ''}</td>
<td>${a.username ?? ''}</td>
<td>${a.agentVersion ?? ''}</td>
<td>${a.registeredAt ? new Date(a.registeredAt).toLocaleString() : ''}</td>
</tr>`;
}
document.getElementById('agentCount').textContent = `(${agentsData.length})`;
}

function filteredTelemetry() {
const q = document.getElementById('searchBox').value.trim().toLowerCase();
const agent = document.getElementById('agentFilter').value;
const sev = document.getElementById('severityFilter').value;
const type = document.getElementById('typeFilter').value;

return telemetryData.filter(t => {
const tSev = normalizeSeverity(t.severity);
const hitSearch =
!q ||
(t.message || '').toLowerCase().includes(q) ||
(t.eventType || '').toLowerCase().includes(q) ||
(t.source || '').toLowerCase().includes(q) ||
(t.agentId || '').toLowerCase().includes(q);

const hitAgent = !agent || t.agentId === agent;
const hitSev = !sev || tSev === sev;
const hitType = !type || t.eventType === type;

return hitSearch && hitAgent && hitSev && hitType;
});
}

function renderTelemetry() {
const data = filteredTelemetry();
const tbody = document.querySelector('#telemetryTable tbody');
tbody.innerHTML = '';

for (const t of data) {
tbody.innerHTML += `<tr>
<td>${t.receivedAt ? new Date(t.receivedAt).toLocaleString() : ''}</td>
<td>${t.agentId ?? ''}</td>
<td>${t.eventType ?? ''}</td>
<td>${sevBadge(t.severity)}</td>
<td>${t.message ?? ''}</td>
</tr>`;
}

document.getElementById('telemetryCount').textContent = `(${data.length})`;

const alerts = data.filter(t => ['high','critical'].includes(normalizeSeverity(t.severity)));
const aBody = document.querySelector('#alertsTable tbody');
aBody.innerHTML = '';

for (const t of alerts) {
aBody.innerHTML += `<tr>
<td>${t.receivedAt ? new Date(t.receivedAt).toLocaleString() : ''}</td>
<td>${t.agentId ?? ''}</td>
<td>${t.eventType ?? ''}</td>
<td>${sevBadge(t.severity)}</td>
<td>${t.message ?? ''}</td>
</tr>`;
}

document.getElementById('alertCount').textContent = `(${alerts.length})`;
}

function exportCsv() {
const rows = filteredTelemetry();
const headers = ["receivedAt","agentId","eventType","severity","source","message","timestamp","metadataJson"];
const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;

const csv = [
headers.join(","),
...rows.map(r => headers.map(h => esc(r[h])).join(","))
].join("\n");

const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
const ts = new Date().toISOString().replace(/[:.]/g, "-");
a.href = url;
a.download = `telemetry-${ts}.csv`;
document.body.appendChild(a);
a.click();
a.remove();
URL.revokeObjectURL(url);
}

async function loadAll() {
const status = document.getElementById('status');
status.textContent = 'Loading...';
try {
const [agents, telemetry] = await Promise.all([
apiGet('/api/v1/agents'),
apiGet('/api/v1/telemetry/recent?take=200')
]);
agentsData = toArray(agents);
telemetryData = toArray(telemetry);
renderAgents();
populateFilters();
renderTelemetry();
status.innerHTML = '<span class="ok">Loaded</span>';
} catch (e) {
status.innerHTML = `<span class="warn">${e.message}</span>`;
}
}

async function startRealtime() {
const connection = new signalR.HubConnectionBuilder()
.withUrl("/hubs/telemetry")
.withAutomaticReconnect()
.build();

connection.on("telemetry_received", (payload) => {
console.log("Realtime telemetry:", payload);
loadAll();
});

try {
await connection.start();
console.log("SignalR connected");
} catch (err) {
console.error("SignalR connection failed:", err);
setTimeout(startRealtime, 3000);
}
}

loadAll();
startRealtime();
// Optional fallback polling:
// setInterval(loadAll, 10000);
</script>
</body>
</html>
